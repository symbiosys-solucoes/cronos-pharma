


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > DadosPedido</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/highlight-idea.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">br.symbiosys.solucoes.cronospharma.cronospharma.entidades.cronos</a>
</div>

<h1>Coverage Summary for Class: DadosPedido (br.symbiosys.solucoes.cronospharma.cronospharma.entidades.cronos)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">DadosPedido</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (5/5)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<div class="sourceCode" id="sourceCode"><i class="no-highlight">1</i>&nbsp;package br.symbiosys.solucoes.cronospharma.cronospharma.entidades.cronos
<i class="no-highlight">2</i>&nbsp;
<i class="no-highlight">3</i>&nbsp;import org.springframework.jdbc.core.PreparedStatementCallback
<i class="no-highlight">4</i>&nbsp;import org.springframework.jdbc.core.RowMapper
<i class="no-highlight">5</i>&nbsp;import org.springframework.jdbc.core.namedparam.MapSqlParameterSource
<i class="no-highlight">6</i>&nbsp;import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate
<i class="no-highlight">7</i>&nbsp;import org.springframework.stereotype.Repository
<i class="no-highlight">8</i>&nbsp;import java.sql.ResultSet
<i class="no-highlight">9</i>&nbsp;import java.sql.SQLException
<i class="no-highlight">10</i>&nbsp;
<i class="no-highlight">11</i>&nbsp;@Repository
<i class="no-highlight">12</i>&nbsp;class PedidoPalmRepository(
<i class="no-highlight">13</i>&nbsp;    private val jdbcTemplate: NamedParameterJdbcTemplate,
<i class="no-highlight">14</i>&nbsp;    private val itemPedidoPalmRepository: ItemPedidoPalmRepository
<i class="no-highlight">15</i>&nbsp;) {
<i class="no-highlight">16</i>&nbsp;    fun save(pedidoPalm: PedidoPalm): PedidoPalm{
<i class="no-highlight">17</i>&nbsp;
<i class="no-highlight">18</i>&nbsp;        when(pedidoPalm.Origem) {
<i class="no-highlight">19</i>&nbsp;            &quot;EMS&quot; -&gt; {
<i class="no-highlight">20</i>&nbsp;                val dadosPedido = getDadosPedido(pedidoPalm)
<i class="no-highlight">21</i>&nbsp;                if (dadosPedido != null) {
<i class="no-highlight">22</i>&nbsp;                    pedidoPalm.CodCliFor = dadosPedido.codClifor
<i class="no-highlight">23</i>&nbsp;                    pedidoPalm.CodVendedor = dadosPedido.codVendedor
<i class="no-highlight">24</i>&nbsp;                    pedidoPalm.CodPortador = dadosPedido.codPortador
<i class="no-highlight">25</i>&nbsp;                    pedidoPalm.CodCondPag = dadosPedido.codCondPag
<i class="no-highlight">26</i>&nbsp;                }
<i class="no-highlight">27</i>&nbsp;
<i class="no-highlight">28</i>&nbsp;            }
<i class="no-highlight">29</i>&nbsp;            &quot;CONSYS&quot; -&gt; {
<i class="no-highlight">30</i>&nbsp;                val dadosPedido = getDadosPedido(pedidoPalm)
<i class="no-highlight">31</i>&nbsp;                if (dadosPedido != null) {
<i class="no-highlight">32</i>&nbsp;                    pedidoPalm.CodCliFor = dadosPedido.codClifor
<i class="no-highlight">33</i>&nbsp;                    pedidoPalm.CodVendedor = dadosPedido.codVendedor
<i class="no-highlight">34</i>&nbsp;                    pedidoPalm.CodPortador = dadosPedido.codPortador
<i class="no-highlight">35</i>&nbsp;                    pedidoPalm.CodCondPag = dadosPedido.codCondPag
<i class="no-highlight">36</i>&nbsp;                }
<i class="no-highlight">37</i>&nbsp;            }
<i class="no-highlight">38</i>&nbsp;        }
<i class="no-highlight">39</i>&nbsp;
<i class="no-highlight">40</i>&nbsp;        val params = MapSqlParameterSource()
<i class="no-highlight">41</i>&nbsp;            .addValue(&quot;origem&quot;, pedidoPalm.Origem)
<i class="no-highlight">42</i>&nbsp;            .addValue(&quot;idEmpresa&quot;, pedidoPalm.IdEmpresa)
<i class="no-highlight">43</i>&nbsp;            .addValue(&quot;numPedidoPalm&quot;, pedidoPalm.NumPedidoPalm)
<i class="no-highlight">44</i>&nbsp;            .addValue(&quot;codVendedor&quot;, pedidoPalm.CodVendedor)
<i class="no-highlight">45</i>&nbsp;            .addValue(&quot;codCliFor&quot;, pedidoPalm.CodCliFor)
<i class="no-highlight">46</i>&nbsp;            .addValue(&quot;dataPedido&quot;, pedidoPalm.DataPedido)
<i class="no-highlight">47</i>&nbsp;            .addValue(&quot;codCondPag&quot;, pedidoPalm.CodCondPag)
<i class="no-highlight">48</i>&nbsp;            .addValue(&quot;codPortador&quot;,pedidoPalm.CodPortador)
<i class="no-highlight">49</i>&nbsp;            .addValue(&quot;valorTotal&quot;, pedidoPalm.TotalPedido)
<i class="no-highlight">50</i>&nbsp;            .addValue(&quot;situacao&quot;, pedidoPalm.SituacaoPedido)
<i class="no-highlight">51</i>&nbsp;            .addValue(&quot;idUsuario&quot;, pedidoPalm.IdUsuario)
<i class="no-highlight">52</i>&nbsp;            .addValue(&quot;dataOperacao&quot;,pedidoPalm.DataOperacao)
<i class="no-highlight">53</i>&nbsp;            .addValue(&quot;cnpj&quot;, pedidoPalm.CnpjCpfCliFor)
<i class="no-highlight">54</i>&nbsp;            .addValue(&quot;codFilial&quot;, pedidoPalm.CodFilial)
<i class="no-highlight">55</i>&nbsp;
<i class="no-highlight">56</i>&nbsp;        val pedido = jdbcTemplate.query(sqlInsertPedidoPalm, params, mapperPedidoPalm).first() ?: null
<i class="no-highlight">57</i>&nbsp;        if (pedido == null) {
<i class="no-highlight">58</i>&nbsp;            throw SQLException(&quot;Não foi Possivel inserir o pedido&quot;)
<i class="no-highlight">59</i>&nbsp;        }
<i class="no-highlight">60</i>&nbsp;        pedido.itens = pedidoPalm.itens
<i class="no-highlight">61</i>&nbsp;
<i class="no-highlight">62</i>&nbsp;        pedido.itens.map { itemPedidoPalmRepository.save(it,pedido) }
<i class="no-highlight">63</i>&nbsp;
<i class="no-highlight">64</i>&nbsp;        return pedido
<i class="no-highlight">65</i>&nbsp;    }
<i class="no-highlight">66</i>&nbsp;
<i class="no-highlight">67</i>&nbsp;    private fun getDadosPedido(pedido: PedidoPalm): DadosPedido?{
<i class="no-highlight">68</i>&nbsp;        val params = MapSqlParameterSource()
<i class="no-highlight">69</i>&nbsp;            .addValue(&quot;cnpj&quot;, pedido.CnpjCpfCliFor)
<i class="no-highlight">70</i>&nbsp;            .addValue(&quot;origem&quot;, pedido.Origem)
<i class="no-highlight">71</i>&nbsp;        return jdbcTemplate.query(sqlDadosItem, params, mapperDadosPedido).first() ?: null
<i class="no-highlight">72</i>&nbsp;    }
<i class="no-highlight">73</i>&nbsp;
<i class="no-highlight">74</i>&nbsp;    fun findById(id: Long):PedidoPalm?{
<i class="no-highlight">75</i>&nbsp;
<i class="no-highlight">76</i>&nbsp;        val pedido = jdbcTemplate.query(&quot;select * from PedidoPalm where IdPedidoPalm = :id&quot;, MapSqlParameterSource().addValue(&quot;id&quot;, id), mapperPedidoPalm).first()
<i class="no-highlight">77</i>&nbsp;        pedido.itens = itemPedidoPalmRepository.findAllByIdPedido(pedido?.IdPedidoPalm ?:0 )
<i class="no-highlight">78</i>&nbsp;
<i class="no-highlight">79</i>&nbsp;        return pedido
<i class="no-highlight">80</i>&nbsp;    }
<i class="no-highlight">81</i>&nbsp;
<i class="no-highlight">82</i>&nbsp;    fun toMovimento(pedido: PedidoPalm): String? {
<i class="no-highlight">83</i>&nbsp;        if(pedido.IdPedidoPalm == null || pedido.SituacaoPedido != &quot;P&quot; ){
<i class="no-highlight">84</i>&nbsp;            return &quot;0&quot;
<i class="no-highlight">85</i>&nbsp;        }
<i class="no-highlight">86</i>&nbsp;
<i class="no-highlight">87</i>&nbsp;        return jdbcTemplate.query(sqlToMovimento, MapSqlParameterSource().addValue(&quot;idPedidoPalm&quot;, pedido.IdPedidoPalm), mapperString).first()
<i class="no-highlight">88</i>&nbsp;
<i class="no-highlight">89</i>&nbsp;    }
<i class="no-highlight">90</i>&nbsp;
<i class="no-highlight">91</i>&nbsp;    companion object{
<i class="no-highlight">92</i>&nbsp;        private final val mapperDadosPedido = RowMapper&lt;DadosPedido&gt;{ rs: ResultSet, rowNum: Int -&gt;
<i class="no-highlight">93</i>&nbsp;            DadosPedido(
<i class="no-highlight">94</i>&nbsp;                codClifor = rs.getString(&quot;CODCLIFOR&quot;),
<i class="no-highlight">95</i>&nbsp;                codPortador = rs.getString(&quot;CODPORTADOR&quot;),
<i class="no-highlight">96</i>&nbsp;                codCondPag = rs.getString(&quot;CODCONDPAG&quot;),
<i class="no-highlight">97</i>&nbsp;                codVendedor = rs.getString(&quot;CODVENDEDOR&quot;)
<i class="no-highlight">98</i>&nbsp;            )
<i class="no-highlight">99</i>&nbsp;
<i class="no-highlight">100</i>&nbsp;        }
<i class="no-highlight">101</i>&nbsp;        private final val mapperPedidoPalm = RowMapper&lt;PedidoPalm&gt; {rs: ResultSet, rowNum: Int -&gt;
<i class="no-highlight">102</i>&nbsp;            PedidoPalm(
<i class="no-highlight">103</i>&nbsp;                Origem = rs.getString(&quot;Origem&quot;),
<i class="no-highlight">104</i>&nbsp;                IdEmpresa = rs.getLong(&quot;IdEmpresa&quot;),
<i class="no-highlight">105</i>&nbsp;                NumPedidoPalm = rs.getString(&quot;NumPedidoPalm&quot;),
<i class="no-highlight">106</i>&nbsp;                CodVendedor = rs.getString(&quot;CodVendedor&quot;),
<i class="no-highlight">107</i>&nbsp;                CodCliFor = rs.getString(&quot;CodCliFor&quot;),
<i class="no-highlight">108</i>&nbsp;                DataPedido = rs.getTimestamp(&quot;DataPedido&quot;).toLocalDateTime(),
<i class="no-highlight">109</i>&nbsp;                PercComissao = rs.getDouble(&quot;PercComissao&quot;),
<i class="no-highlight">110</i>&nbsp;                CodCondPag = rs.getString(&quot;CodCondPag&quot;),
<i class="no-highlight">111</i>&nbsp;                CodPortador = rs.getString(&quot;CodPortador&quot;),
<i class="no-highlight">112</i>&nbsp;                PercDesconto = rs.getDouble(&quot;PercDesconto&quot;),
<i class="no-highlight">113</i>&nbsp;                TotalPedido = rs.getBigDecimal(&quot;TotalPedido&quot;),
<i class="no-highlight">114</i>&nbsp;                DataEntrega = rs.getTimestamp(&quot;DataEntrega&quot;)?.toLocalDateTime() ?: null,
<i class="no-highlight">115</i>&nbsp;                Observacoes = rs.getString(&quot;Observacoes&quot;),
<i class="no-highlight">116</i>&nbsp;                IdExpedicao = rs.getLong(&quot;IdExpedicao&quot;),
<i class="no-highlight">117</i>&nbsp;                DataProxVisita = rs.getTimestamp(&quot;DataProxVisita&quot;)?.toLocalDateTime() ?: null,
<i class="no-highlight">118</i>&nbsp;                SituacaoPedido = rs.getString(&quot;SituacaoPedido&quot;),
<i class="no-highlight">119</i>&nbsp;                NumNF = rs.getString(&quot;NumNF&quot;),
<i class="no-highlight">120</i>&nbsp;                LogImportacao = rs.getString(&quot;LogImportacao&quot;),
<i class="no-highlight">121</i>&nbsp;                IdUsuario = rs.getString(&quot;IdUsuario&quot;),
<i class="no-highlight">122</i>&nbsp;                DataOperacao = rs.getTimestamp(&quot;DataOperacao&quot;).toLocalDateTime(),
<i class="no-highlight">123</i>&nbsp;                StatusRetorno = rs.getString(&quot;StatusRetorno&quot;),
<i class="no-highlight">124</i>&nbsp;                NumPedidoCRONOS = rs.getString(&quot;NumPedidoCRONOS&quot;),
<i class="no-highlight">125</i>&nbsp;                CodRetorno = rs.getString(&quot;CodRetorno&quot;),
<i class="no-highlight">126</i>&nbsp;                DscRetorno = rs.getString(&quot;DscRetorno&quot;),
<i class="no-highlight">127</i>&nbsp;                CnpjCpfCliFor = rs.getString(&quot;CnpjCpfCliFor&quot;),
<i class="no-highlight">128</i>&nbsp;                ArqRetPed = rs.getString(&quot;ArqRetPed&quot;),
<i class="no-highlight">129</i>&nbsp;                ArqRetNF = rs.getString(&quot;ArqRetNF&quot;),
<i class="no-highlight">130</i>&nbsp;                CodFilial = rs.getString(&quot;CodFilial&quot;),
<i class="no-highlight">131</i>&nbsp;                ArqRet2Ped = rs.getString(&quot;ArqRet2Ped&quot;),
<i class="no-highlight">132</i>&nbsp;                VerLayout = rs.getString(&quot;VerLayout&quot;),
<i class="no-highlight">133</i>&nbsp;                NumPedidoPalmAux = rs.getString(&quot;NumPedidoPalmAux&quot;),
<i class="no-highlight">134</i>&nbsp;                itens = mutableListOf(),
<i class="no-highlight">135</i>&nbsp;                IdPedidoPalm = rs.getLong(&quot;IdPedidoPalm&quot;)
<i class="no-highlight">136</i>&nbsp;            )
<i class="no-highlight">137</i>&nbsp;        }
<i class="no-highlight">138</i>&nbsp;        private final val mapperString = RowMapper&lt;String&gt; { rs: ResultSet, rowNum: Int -&gt;
<i class="no-highlight">139</i>&nbsp;            rs.getString(&quot;VALOR&quot;)
<i class="no-highlight">140</i>&nbsp;        }
<i class="no-highlight">141</i>&nbsp;        private final val sqlDadosItem = &quot;&quot; +
<i class="no-highlight">142</i>&nbsp;                &quot;\n&quot; +
<i class="no-highlight">143</i>&nbsp;                &quot;  DECLARE @CNPJ VARCHAR(14), @ORIGEM VARCHAR(20)\n&quot; +
<i class="no-highlight">144</i>&nbsp;                &quot;  SET @CNPJ = :cnpj\n&quot; +
<i class="no-highlight">145</i>&nbsp;                &quot;  SET @ORIGEM = :origem\n&quot; +
<i class="no-highlight">146</i>&nbsp;                &quot;            IF (@ORIGEM = &#39;EMS&#39;)\n&quot; +
<i class="no-highlight">147</i>&nbsp;                &quot;\t\t\t  BEGIN\n&quot; +
<i class="no-highlight">148</i>&nbsp;                &quot;              SELECT\n&quot; +
<i class="no-highlight">149</i>&nbsp;                &quot;              CODVENDEDOR = ISNULL(Codfunc,&#39;00001&#39;),\n&quot; +
<i class="no-highlight">150</i>&nbsp;                &quot;              CODCLIFOR = codclifor,\n&quot; +
<i class="no-highlight">151</i>&nbsp;                &quot;              CODCONDPAG = ISNULL(codcondpag,&#39;01&#39;),\n&quot; +
<i class="no-highlight">152</i>&nbsp;                &quot;              CODPORTADOR = ISNULL(codportador,&#39;01&#39;)\n&quot; +
<i class="no-highlight">153</i>&nbsp;                &quot;              FROM CLI_FOR WHERE dbo.fn_LimpaStr(CPFCGCCLIFOR) = @CNPJ               \n&quot; +
<i class="no-highlight">154</i>&nbsp;                &quot;              END\n&quot; +
<i class="no-highlight">155</i>&nbsp;                &quot;            IF (@ORIGEM = &#39;CONSYS&#39;)\n&quot; +
<i class="no-highlight">156</i>&nbsp;                &quot;              BEGIN\n&quot; +
<i class="no-highlight">157</i>&nbsp;                &quot;\t\t\t  SELECT\n&quot; +
<i class="no-highlight">158</i>&nbsp;                &quot;              CODVENDEDOR = ISNULL(codfunc,&#39;00001&#39;),\n&quot; +
<i class="no-highlight">159</i>&nbsp;                &quot;              CODCLIFOR = codclifor,\n&quot; +
<i class="no-highlight">160</i>&nbsp;                &quot;              CODCONDPAG = ISNULL(codcondpag,&#39;01&#39;),\n&quot; +
<i class="no-highlight">161</i>&nbsp;                &quot;              CODPORTADOR = ISNULL(codportador,&#39;01&#39;)              \n&quot; +
<i class="no-highlight">162</i>&nbsp;                &quot;\t\t\t  FROM CLI_FOR WHERE dbo.fn_LimpaStr(CPFCGCCLIFOR) = @CNPJ \n&quot; +
<i class="no-highlight">163</i>&nbsp;                &quot;              END&quot;
<i class="no-highlight">164</i>&nbsp;
<i class="no-highlight">165</i>&nbsp;        private final val sqlInsertPedidoPalm =
<i class="no-highlight">166</i>&nbsp;            &quot;BEGIN TRANSACTION \n&quot; +
<i class="no-highlight">167</i>&nbsp;                    &quot;\n&quot; +
<i class="no-highlight">168</i>&nbsp;                    &quot; INSERT INTO  PedidoPalm ( Origem, IdEmpresa, NumPedidoPalm, CodVendedor, CodCliFor, DataPedido, CodCondPag, CodPortador, TotalPedido, SituacaoPedido, IdUsuario, DataOperacao, CnpjCpfCliFor, CodFilial)\n&quot; +
<i class="no-highlight">169</i>&nbsp;                    &quot;              \n&quot; +
<i class="no-highlight">170</i>&nbsp;                    &quot;\tOUTPUT INSERTED.*\n&quot; +
<i class="no-highlight">171</i>&nbsp;                    &quot;\t\tSELECT \t\n&quot; +
<i class="no-highlight">172</i>&nbsp;                    &quot;\t\tORIGEM = :origem ,\n&quot; +
<i class="no-highlight">173</i>&nbsp;                    &quot;\t\tIDEMPRESA = :idEmpresa,\n&quot; +
<i class="no-highlight">174</i>&nbsp;                    &quot;\t\tNUMPEDIDOPALM = :numPedidoPalm, \n&quot; +
<i class="no-highlight">175</i>&nbsp;                    &quot;\t\tCODVENDEDOR = ISNULL(:codVendedor,&#39;00001&#39;),\n&quot; +
<i class="no-highlight">176</i>&nbsp;                    &quot;\t\tCODCLIFOR = :codCliFor,\n&quot; +
<i class="no-highlight">177</i>&nbsp;                    &quot;\t\tDATAPEDIDO = :dataPedido,\n&quot; +
<i class="no-highlight">178</i>&nbsp;                    &quot;\t\tCODCONDPAG = ISNULL(:codCondPag,&#39;01&#39;),\n&quot; +
<i class="no-highlight">179</i>&nbsp;                    &quot;\t\tCODPORTADOR = ISNULL(:codPortador,&#39;01&#39;),\n&quot; +
<i class="no-highlight">180</i>&nbsp;                    &quot;\t\tTOTAL = :valorTotal,\n&quot; +
<i class="no-highlight">181</i>&nbsp;                    &quot;\t\tSITUACAO = :situacao,\n&quot; +
<i class="no-highlight">182</i>&nbsp;                    &quot;\t\tIDUSUARIO = :idUsuario,\n&quot; +
<i class="no-highlight">183</i>&nbsp;                    &quot;\t\tDATAOPERACAO = :dataOperacao,\n&quot; +
<i class="no-highlight">184</i>&nbsp;                    &quot;\t\tCNPJ = :cnpj,\n&quot; +
<i class="no-highlight">185</i>&nbsp;                    &quot;\t\tFILIAL = :codFilial\n&quot; +
<i class="no-highlight">186</i>&nbsp;                    &quot;\n&quot; +
<i class="no-highlight">187</i>&nbsp;                    &quot;IF @@ERROR = 0\n&quot; +
<i class="no-highlight">188</i>&nbsp;                    &quot;COMMIT\n&quot; +
<i class="no-highlight">189</i>&nbsp;                    &quot;ELSE\n&quot; +
<i class="no-highlight">190</i>&nbsp;                    &quot;ROLLBACK\n&quot; +
<i class="no-highlight">191</i>&nbsp;                    &quot;RAISERROR(&#39;Nao foi possivel inserir os dados&#39;,1,1)\t\t&quot;
<i class="no-highlight">192</i>&nbsp;
<i class="no-highlight">193</i>&nbsp;    }
<i class="no-highlight">194</i>&nbsp;
<i class="no-highlight">195</i>&nbsp;    private final val sqlToMovimento = &quot;&quot; +
<i class="no-highlight">196</i>&nbsp;            &quot;\n&quot; +
<i class="no-highlight">197</i>&nbsp;            &quot;            DECLARE\n&quot; +
<i class="no-highlight">198</i>&nbsp;            &quot;                     @IdPedidoPalm \tINT, @IdItemPedidoPalm INT,\n&quot; +
<i class="no-highlight">199</i>&nbsp;            &quot;                     @PrecoUnit \t\tMONEY,\n&quot; +
<i class="no-highlight">200</i>&nbsp;            &quot;                     @Qtd      \t\tNUMERIC(15,6),  @QtdSolic NUMERIC(15,6),\n&quot; +
<i class="no-highlight">201</i>&nbsp;            &quot;                     @SdoAtual    NUMERIC(15,6),\n&quot; +
<i class="no-highlight">202</i>&nbsp;            &quot;                           @IdMovNew  \t\tINT,\n&quot; +
<i class="no-highlight">203</i>&nbsp;            &quot;                           @Item\t  \t\tINT,\n&quot; +
<i class="no-highlight">204</i>&nbsp;            &quot;                           @IdItemMovNew  \t\tINT,  @NumeroMovNew VARCHAR(20),\n&quot; +
<i class="no-highlight">205</i>&nbsp;            &quot;                           @AceitaEstoqueNegativo   VARCHAR(1),  @ControleLote  VARCHAR(1),\n&quot; +
<i class="no-highlight">206</i>&nbsp;            &quot;                           @IdProduto\t \tINT,\n&quot; +
<i class="no-highlight">207</i>&nbsp;            &quot;                           @CodProduto\t \tVARCHAR(20),\n&quot; +
<i class="no-highlight">208</i>&nbsp;            &quot;                           @IDMOV \t\t\tINT,\n&quot; +
<i class="no-highlight">209</i>&nbsp;            &quot;                           @CODFILIAL\t \tVARCHAR(2), @CODLOCAL  VARCHAR(2), @IDEMPRESA INT,\n&quot; +
<i class="no-highlight">210</i>&nbsp;            &quot;                           @INDPRECOVENDA \t\tVARCHAR(1),\n&quot; +
<i class="no-highlight">211</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">212</i>&nbsp;            &quot;                           @SITUACAOITEMPEDIDO \tVARCHAR(1), @UnidItemMov  VARCHAR(4),\n&quot; +
<i class="no-highlight">213</i>&nbsp;            &quot;                           @PercComissaoItem        NUMERIC(6,2),\n&quot; +
<i class="no-highlight">214</i>&nbsp;            &quot;                           @PercDescontoItem        FLOAT\n&quot; +
<i class="no-highlight">215</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">216</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">217</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">218</i>&nbsp;            &quot;            SET @IDEMPRESA = 1            \n&quot; +
<i class="no-highlight">219</i>&nbsp;            &quot;\t\t\tSET @IdPedidoPalm = :idPedidoPalm\n&quot; +
<i class="no-highlight">220</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">221</i>&nbsp;            &quot;            SET @IdMovNew = 0\n&quot; +
<i class="no-highlight">222</i>&nbsp;            &quot;            IF NOT EXISTS( SELECT 1 FROM Movimento M (NOLOCK) WHERE TipoMov =&#39;2.1&#39; AND IdPedidoPalm = @IdPedidoPalm AND Status &lt;&gt; &#39;C&#39;)\n&quot; +
<i class="no-highlight">223</i>&nbsp;            &quot;            BEGIN\n&quot; +
<i class="no-highlight">224</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">225</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">226</i>&nbsp;            &quot;             SELECT @NumeroMovNew = sym_nextNumMov FROM ZFiliaisCompl WHERE CodFilial = &#39;01&#39;\n&quot; +
<i class="no-highlight">227</i>&nbsp;            &quot;             UPDATE ZFiliaisCompl SET sym_nextNumMov = CAST(sym_nextNumMov as BigInt) + 1\n&quot; +
<i class="no-highlight">228</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">229</i>&nbsp;            &quot;             EXEC @IdMovNew = dbo.sp_NextId &#39;Movimento&#39;\n&quot; +
<i class="no-highlight">230</i>&nbsp;            &quot;             \n&quot; +
<i class="no-highlight">231</i>&nbsp;            &quot;             BEGIN TRANSACTION\n&quot; +
<i class="no-highlight">232</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">233</i>&nbsp;            &quot;             INSERT INTO MOVIMENTO (IDEMPRESA, CODFILIAL, CODLOCAL, IDMOV, TIPOMOV, NUMMOV, DTMOV, CODCLIFOR, CODCONDPAG, CODVENDEDOR, IdRegiao, PERCCOMISSAO, STATUS, PercDesconto, Observacoes, DataEntrega, DataOperacao, IdUsuario, IdPedidoPalm, IdExpedicao, NumMovAux )\n&quot; +
<i class="no-highlight">234</i>&nbsp;            &quot;             SELECT @IdEmpresa,\n&quot; +
<i class="no-highlight">235</i>&nbsp;            &quot;                    Vendedores.CODFILIAL,\n&quot; +
<i class="no-highlight">236</i>&nbsp;            &quot;                    Vendedores.CodLocal,\n&quot; +
<i class="no-highlight">237</i>&nbsp;            &quot;                     @IdMovNew,\n&quot; +
<i class="no-highlight">238</i>&nbsp;            &quot;                  &#39;2.1&#39;,\n&quot; +
<i class="no-highlight">239</i>&nbsp;            &quot;                    CONVERT(VARCHAR(20), @NumeroMovNew),\n&quot; +
<i class="no-highlight">240</i>&nbsp;            &quot;                    PedidoPalm.DataPedido,\n&quot; +
<i class="no-highlight">241</i>&nbsp;            &quot;                    PedidoPalm.CODCLIFOR,\n&quot; +
<i class="no-highlight">242</i>&nbsp;            &quot;                    PedidoPalm.CODCONDPAG,\n&quot; +
<i class="no-highlight">243</i>&nbsp;            &quot;                    PedidoPalm.CODVENDEDOR,\n&quot; +
<i class="no-highlight">244</i>&nbsp;            &quot;                    Cli_For.IdRegiao,\n&quot; +
<i class="no-highlight">245</i>&nbsp;            &quot;                    Vendedores.ComissaoVendedor,\n&quot; +
<i class="no-highlight">246</i>&nbsp;            &quot;                    &#39;T&#39;,\n&quot; +
<i class="no-highlight">247</i>&nbsp;            &quot;                    ISNULL(PedidoPalm.PercDesconto,0),\n&quot; +
<i class="no-highlight">248</i>&nbsp;            &quot;                    CONVERT(VARCHAR(400),&#39;Portador: &#39;+ISNULL(Portador.NomePortador,&#39;&#39;)+&#39;  /  &#39;+&#39;Obs: &#39;+ISNULL(PedidoPalm.Observacoes,&#39;&#39;)),\n&quot; +
<i class="no-highlight">249</i>&nbsp;            &quot;                    PedidoPalm.DataEntrega,\n&quot; +
<i class="no-highlight">250</i>&nbsp;            &quot;                    GETDATE(),\n&quot; +
<i class="no-highlight">251</i>&nbsp;            &quot;                    PedidoPalm.Origem,\n&quot; +
<i class="no-highlight">252</i>&nbsp;            &quot;                     PedidoPalm.IdPedidoPalm,\n&quot; +
<i class="no-highlight">253</i>&nbsp;            &quot;                    PedidoPalm.IdExpedicao,\n&quot; +
<i class="no-highlight">254</i>&nbsp;            &quot;                    PedidoPalm.NumNF\n&quot; +
<i class="no-highlight">255</i>&nbsp;            &quot;              FROM PedidoPalm LEFT JOIN Portador ON PedidoPalm.CodPortador = Portador.CodPortador, Cli_For, Vendedores\n&quot; +
<i class="no-highlight">256</i>&nbsp;            &quot;             WHERE PedidoPalm.CodCliFor = Cli_For.CodCliFor\n&quot; +
<i class="no-highlight">257</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">258</i>&nbsp;            &quot;               AND PedidoPalm.CodVendedor = Vendedores.CodVendedor AND PedidoPalm.CodFilial = Vendedores.CodFilial \n&quot; +
<i class="no-highlight">259</i>&nbsp;            &quot;               AND Vendedores.CodFilial IS NOT NULL AND Vendedores.CodLocal IS NOT NULL\n&quot; +
<i class="no-highlight">260</i>&nbsp;            &quot;               AND PedidoPalm.IdPedidoPalm   = @IdPedidoPalm                    \n&quot; +
<i class="no-highlight">261</i>&nbsp;            &quot;\n&quot; +
<i class="no-highlight">262</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">263</i>&nbsp;            &quot;             DECLARE xItens SCROLL CURSOR FOR\n&quot; +
<i class="no-highlight">264</i>&nbsp;            &quot;              SELECT Vendedores.CodFilial, Vendedores.CodLocal, IdItemPedidoPalm, Item, CodProduto, Qtd, IdPrecoTabela, PrecoUnit, ISNULL(PercDescontoItem,0)\n&quot; +
<i class="no-highlight">265</i>&nbsp;            &quot;                FROM ItemPedidoPalm, PedidoPalm, Vendedores\n&quot; +
<i class="no-highlight">266</i>&nbsp;            &quot;               WHERE ItemPedidoPalm.IdPedidoPalm  = PedidoPalm.IdPedidoPalm\n&quot; +
<i class="no-highlight">267</i>&nbsp;            &quot;                 AND PedidoPalm.IdPedidoPalm      = @IdPedidoPalm\n&quot; +
<i class="no-highlight">268</i>&nbsp;            &quot;                 AND PedidoPalm.CodVendedor = Vendedores.CodVendedor \n&quot; +
<i class="no-highlight">269</i>&nbsp;            &quot;                 AND PedidoPalm.CodFilial = Vendedores.CodFilial \n&quot; +
<i class="no-highlight">270</i>&nbsp;            &quot;                 AND Vendedores.CodFilial IS NOT NULL AND Vendedores.CodLocal IS NOT NULL\n&quot; +
<i class="no-highlight">271</i>&nbsp;            &quot;              \n&quot; +
<i class="no-highlight">272</i>&nbsp;            &quot;             FOR READ ONLY\n&quot; +
<i class="no-highlight">273</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">274</i>&nbsp;            &quot;            OPEN xItens\n&quot; +
<i class="no-highlight">275</i>&nbsp;            &quot;            FETCH FIRST FROM xItens\n&quot; +
<i class="no-highlight">276</i>&nbsp;            &quot;             INTO @CodFilial, @CodLocal,\n&quot; +
<i class="no-highlight">277</i>&nbsp;            &quot;                  @IdItemPedidoPalm,\n&quot; +
<i class="no-highlight">278</i>&nbsp;            &quot;                  @Item,\n&quot; +
<i class="no-highlight">279</i>&nbsp;            &quot;                  @CodProduto,\n&quot; +
<i class="no-highlight">280</i>&nbsp;            &quot;                  @Qtd,\n&quot; +
<i class="no-highlight">281</i>&nbsp;            &quot;                  @IndPrecoVenda,\n&quot; +
<i class="no-highlight">282</i>&nbsp;            &quot;                  @PrecoUnit,\n&quot; +
<i class="no-highlight">283</i>&nbsp;            &quot;                  @PercDescontoItem\n&quot; +
<i class="no-highlight">284</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">285</i>&nbsp;            &quot;            WHILE @@FETCH_STATUS = 0\n&quot; +
<i class="no-highlight">286</i>&nbsp;            &quot;            BEGIN\n&quot; +
<i class="no-highlight">287</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">288</i>&nbsp;            &quot;              SELECT @SituacaoItemPedido = &#39;C&#39;\n&quot; +
<i class="no-highlight">289</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">290</i>&nbsp;            &quot;              SELECT @IdProduto = MAX(IdProduto),\n&quot; +
<i class="no-highlight">291</i>&nbsp;            &quot;                     @PercComissaoItem = ISNULL(MAX(ComissaoProduto),0),\n&quot; +
<i class="no-highlight">292</i>&nbsp;            &quot;                     @UnidItemMov  = MAX(Produtos.Unid),\n&quot; +
<i class="no-highlight">293</i>&nbsp;            &quot;                     @ControleLote = ISNULL(MAX(Produtos.ControleLote),&#39;N&#39;)\n&quot; +
<i class="no-highlight">294</i>&nbsp;            &quot;                FROM Produtos\n&quot; +
<i class="no-highlight">295</i>&nbsp;            &quot;               WHERE CodProduto = @CodProduto\n&quot; +
<i class="no-highlight">296</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">297</i>&nbsp;            &quot;              -- Produto nao cadastrado\n&quot; +
<i class="no-highlight">298</i>&nbsp;            &quot;              IF @IdProduto IS NULL\n&quot; +
<i class="no-highlight">299</i>&nbsp;            &quot;                 SELECT @SituacaoItemPedido = &#39;I&#39;\n&quot; +
<i class="no-highlight">300</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">301</i>&nbsp;            &quot;              SELECT @SdoAtual   = ISNULL(MAX(e.SdoAtual),0)\n&quot; +
<i class="no-highlight">302</i>&nbsp;            &quot;                FROM Estoque e\n&quot; +
<i class="no-highlight">303</i>&nbsp;            &quot;               WHERE e.Codfilial = @CodFilial\n&quot; +
<i class="no-highlight">304</i>&nbsp;            &quot;                 AND e.CodLocal  = @CodLocal\n&quot; +
<i class="no-highlight">305</i>&nbsp;            &quot;                 AND e.IdProduto = @IdProduto\n&quot; +
<i class="no-highlight">306</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">307</i>&nbsp;            &quot;              SELECT @AceitaEstoqueNegativo = ISNULL(MAX(Loc.AceitaEstoqueNegativo),&#39;N&#39;)\n&quot; +
<i class="no-highlight">308</i>&nbsp;            &quot;                FROM LocalEstoque Loc\n&quot; +
<i class="no-highlight">309</i>&nbsp;            &quot;               WHERE Loc.IdEmpresa = @IdEmpresa\n&quot; +
<i class="no-highlight">310</i>&nbsp;            &quot;                 AND Loc.CodFilial = @CodFilial\n&quot; +
<i class="no-highlight">311</i>&nbsp;            &quot;                 AND Loc.CodLocal  = @CodLocal\n&quot; +
<i class="no-highlight">312</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">313</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">314</i>&nbsp;            &quot;               SET @QtdSolic = @Qtd\n&quot; +
<i class="no-highlight">315</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">316</i>&nbsp;            &quot;               IF @AceitaEstoqueNegativo = &#39;N&#39;\n&quot; +
<i class="no-highlight">317</i>&nbsp;            &quot;                IF (@Qtd &gt; @SdoAtual)\n&quot; +
<i class="no-highlight">318</i>&nbsp;            &quot;                BEGIN\n&quot; +
<i class="no-highlight">319</i>&nbsp;            &quot;                  IF @SdoAtual &gt; 0\n&quot; +
<i class="no-highlight">320</i>&nbsp;            &quot;                    SELECT @Qtd = @SdoAtual\n&quot; +
<i class="no-highlight">321</i>&nbsp;            &quot;                  ELSE\n&quot; +
<i class="no-highlight">322</i>&nbsp;            &quot;                    SELECT @Qtd = 0\n&quot; +
<i class="no-highlight">323</i>&nbsp;            &quot;                  SELECT @SituacaoItemPedido = &#39;I&#39;\n&quot; +
<i class="no-highlight">324</i>&nbsp;            &quot;                END\n&quot; +
<i class="no-highlight">325</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">326</i>&nbsp;            &quot;               IF @IdProduto IS NOT NULL AND NOT EXISTS (SELECT 1 FROM ItensMov im (NOLOCK) WHERE im.IdMov = @IdMovNew AND im.IdProduto = @IdProduto)\n&quot; +
<i class="no-highlight">327</i>&nbsp;            &quot;               BEGIN\n&quot; +
<i class="no-highlight">328</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">329</i>&nbsp;            &quot;                EXEC @IdItemMovNew = dbo.sp_NextId &#39;ItensMov&#39;\n&quot; +
<i class="no-highlight">330</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">331</i>&nbsp;            &quot;                INSERT INTO ItensMov (IdEmpresa, IdItemMov, IDMOV, IdProduto, UnidItemMov,  QtdSolic, QTD, PRECOUNIT, IDPRECOTABELA, PercDescontoItem, PercComissaoItem, DATAOPERACAO, IDUSUARIO)\n&quot; +
<i class="no-highlight">332</i>&nbsp;            &quot;                VALUES(@IdEmpresa,\n&quot; +
<i class="no-highlight">333</i>&nbsp;            &quot;                       @IdItemMovNew,\n&quot; +
<i class="no-highlight">334</i>&nbsp;            &quot;                       @IdMovNew,\n&quot; +
<i class="no-highlight">335</i>&nbsp;            &quot;                       @IdProduto,\n&quot; +
<i class="no-highlight">336</i>&nbsp;            &quot;                       @UnidItemMov,\n&quot; +
<i class="no-highlight">337</i>&nbsp;            &quot;                       @QtdSolic,\n&quot; +
<i class="no-highlight">338</i>&nbsp;            &quot;                       dbo.fn_Fmt(@QTD,&#39;Q&#39;),\n&quot; +
<i class="no-highlight">339</i>&nbsp;            &quot;                       dbo.fn_Fmt(@PRECOUNIT,&#39;P&#39;),\n&quot; +
<i class="no-highlight">340</i>&nbsp;            &quot;                       @IndPrecoVenda,\n&quot; +
<i class="no-highlight">341</i>&nbsp;            &quot;                       @PercDescontoItem,\n&quot; +
<i class="no-highlight">342</i>&nbsp;            &quot;                       @PercComissaoItem,\n&quot; +
<i class="no-highlight">343</i>&nbsp;            &quot;                     GETDATE(),\n&quot; +
<i class="no-highlight">344</i>&nbsp;            &quot;                     &#39;PALM&#39;\n&quot; +
<i class="no-highlight">345</i>&nbsp;            &quot;                      )\n&quot; +
<i class="no-highlight">346</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">347</i>&nbsp;            &quot;                   IF @ControleLote = &#39;S&#39;\n&quot; +
<i class="no-highlight">348</i>&nbsp;            &quot;                     EXEC dbo.sp_GeraItemLoteAuto @IdItemMovNew\n&quot; +
<i class="no-highlight">349</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">350</i>&nbsp;            &quot;               END\n&quot; +
<i class="no-highlight">351</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">352</i>&nbsp;            &quot;               UPDATE dbo.ItemPedidoPalm SET SituacaoItemPedido = @SituacaoItemPedido, QtdConfirmada = @Qtd\n&quot; +
<i class="no-highlight">353</i>&nbsp;            &quot;                WHERE IdItemPedidoPalm  = @IdItemPedidoPalm\n&quot; +
<i class="no-highlight">354</i>&nbsp;            &quot;              \n&quot; +
<i class="no-highlight">355</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">356</i>&nbsp;            &quot;              FETCH NEXT FROM xItens\n&quot; +
<i class="no-highlight">357</i>&nbsp;            &quot;               INTO @CodFilial, @CodLocal,\n&quot; +
<i class="no-highlight">358</i>&nbsp;            &quot;                    @IdItemPedidoPalm,\n&quot; +
<i class="no-highlight">359</i>&nbsp;            &quot;                    @Item,\n&quot; +
<i class="no-highlight">360</i>&nbsp;            &quot;                    @CodProduto,\n&quot; +
<i class="no-highlight">361</i>&nbsp;            &quot;                    @Qtd,\n&quot; +
<i class="no-highlight">362</i>&nbsp;            &quot;                    @IndPrecoVenda,\n&quot; +
<i class="no-highlight">363</i>&nbsp;            &quot;                    @PrecoUnit,\n&quot; +
<i class="no-highlight">364</i>&nbsp;            &quot;                    @PercDescontoItem\n&quot; +
<i class="no-highlight">365</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">366</i>&nbsp;            &quot;            END\n&quot; +
<i class="no-highlight">367</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">368</i>&nbsp;            &quot;            CLOSE xItens\n&quot; +
<i class="no-highlight">369</i>&nbsp;            &quot;            DEALLOCATE xItens\n&quot; +
<i class="no-highlight">370</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">371</i>&nbsp;            &quot;            -- Grava o pedido como C-Confirmado\n&quot; +
<i class="no-highlight">372</i>&nbsp;            &quot;            IF EXISTS (SELECT 1 FROM Movimento WHERE IdMov = @IdMovNew)\n&quot; +
<i class="no-highlight">373</i>&nbsp;            &quot;             UPDATE PedidoPalm SET SituacaoPedido = &#39;C&#39;, NumPedidoCRONOS = @NumeroMovNew\n&quot; +
<i class="no-highlight">374</i>&nbsp;            &quot;              WHERE IdPedidoPalm  = @IdPedidoPalm\n&quot; +
<i class="no-highlight">375</i>&nbsp;            &quot;            ELSE\n&quot; +
<i class="no-highlight">376</i>&nbsp;            &quot;             SET @IdMovNew = 0        \n&quot; +
<i class="no-highlight">377</i>&nbsp;            &quot;             SELECT VALOR = @NumeroMovNew\n&quot; +
<i class="no-highlight">378</i>&nbsp;            &quot;            END \n&quot; +
<i class="no-highlight">379</i>&nbsp;            &quot;            \n&quot; +
<i class="no-highlight">380</i>&nbsp;            &quot;\n&quot; +
<i class="no-highlight">381</i>&nbsp;            &quot;\t\t\tIF @@ERROR = 0\n&quot; +
<i class="no-highlight">382</i>&nbsp;            &quot;\t\t\tCOMMIT\n&quot; +
<i class="no-highlight">383</i>&nbsp;            &quot;\t\t\tELSE\n&quot; +
<i class="no-highlight">384</i>&nbsp;            &quot;\t\t\tROLLBACK\n&quot; +
<i class="no-highlight">385</i>&nbsp;            &quot;\t\t\tRAISERROR(&#39;Nao foi possivel inserir os dados&#39;,1,1)        \n&quot;
<i class="no-highlight">386</i>&nbsp;
<i class="no-highlight">387</i>&nbsp;}
<i class="no-highlight">388</i>&nbsp;
<b class="fc"><i class="no-highlight">389</i>&nbsp;data class DadosPedido(</b>
<b class="fc"><i class="no-highlight">390</i>&nbsp;    val codClifor: String?,</b>
<b class="fc"><i class="no-highlight">391</i>&nbsp;    val codPortador: String?,</b>
<b class="fc"><i class="no-highlight">392</i>&nbsp;    val codVendedor: String?,</b>
<b class="fc"><i class="no-highlight">393</i>&nbsp;    val codCondPag: String?</b>
<i class="no-highlight">394</i>&nbsp;)
</div>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
        var codeBlock = document.getElementById('sourceCode');

        if (codeBlock) {
            hljs.highlightBlock(codeBlock);
        }
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2021-09-11 20:02</div>
</div>
</body>
</html>
